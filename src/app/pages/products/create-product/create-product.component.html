<app-layouts>
  <div class="container-xl px-4">
    <app-page-title
      title="Create Products"
      description="This is will be the description of user list!"
    ></app-page-title>
    <div class="row">
      <div class="col-lg-8">
        <!-- Product Info Section -->
        <div class="card">
          <h5>Product Information</h5>
          <div class="mb-3">
            <label class="form-label">Title</label>
            <input
              type="text"
              class="form-control"
              placeholder="Enter product title"
              [(ngModel)]="product.title"
            />
          </div>
          <div class="mb-3">
            <label class="form-label">Description</label>
            <quill-editor
              [(ngModel)]="product.description"
              [style]="{ height: '200px', width: '100%' }"
              [modules]="{
                toolbar: [
                  ['bold', 'italic', 'underline'],
                  [{ align: [] }],
                  ['link']
                ]
              }"
              format="json"
            ></quill-editor>
          </div>
          <div class="mb-3">
            <app-multiple-upload
              (mediaUrlsChanged)="onMediaUrlsChanged($event)"
            ></app-multiple-upload>
          </div>
          <div class="mb-3">
            <label class="form-label">Choose a product category</label>
            <select class="form-select" [(ngModel)]="product.category">
              <option>Apparel</option>
              <option>Electronics</option>
              <option>Home & Garden</option>
            </select>
            <small class="text-muted"
              >Categories affect taxes and metafields</small
            >
          </div>
        </div>

        <!-- Pricing Section -->
        <div class="card">
          <h5>Pricing</h5>
          <div class="row mb-3">
            <div class="col-md-4">
              <label class="form-label">Price</label>
              <input
                type="number"
                class="form-control"
                placeholder="$0.00"
                [(ngModel)]="product.price"
                (input)="updateProfitMargin()"
              />
            </div>
            <div class="col-md-4">
              <label class="form-label"
                >Compare-at price
                <i
                  class="fas fa-info-circle"
                  title="Original price before discount."
                ></i
              ></label>
              <input
                type="number"
                class="form-control"
                placeholder="$0.00"
                [(ngModel)]="product.compareAtPrice"
              />
            </div>
          </div>
          <div class="row">
            <div class="col-md-4">
              <label class="form-label"
                >Cost per item
                <i
                  class="fas fa-info-circle"
                  title="How much it costs you to buy or make this product."
                ></i
              ></label>
              <input
                type="number"
                class="form-control"
                [(ngModel)]="product.costPerItem"
                (input)="updateProfitMargin()"
              />
            </div>
            <div class="col-md-4">
              <label class="form-label">Profit</label>
              <input
                type="text"
                class="form-control"
                [value]="profit"
                disabled
              />
            </div>
            <div class="col-md-4">
              <label class="form-label">Margin</label>
              <input
                type="text"
                class="form-control"
                [value]="margin"
                disabled
              />
            </div>
          </div>
        </div>

        <!-- Variants Section -->
        <div class="card">
          <h5>Variants</h5>
          <div id="variant-options">
            <div
              *ngFor="let option of variantOptions; let i = index"
              class="mb-4 border p-3 rounded variant-option"
            >
              <label class="form-label">Option name</label>
              <input
                type="text"
                class="form-control mb-2"
                [value]="option.name"
                disabled
              />

              <label class="form-label">Option values</label>
              <div class="variant-option-values" [id]="option.id">
                <div
                  *ngFor="
                    let value of option.values;
                    let j = index;
                    trackBy: trackByIndex
                  "
                >
                  <input
                    type="text"
                    class="form-control mb-2"
                    [placeholder]="
                      option.name === 'Size'
                        ? 'e.g. M'
                        : option.name === 'Color'
                        ? 'e.g. Red'
                        : 'e.g. Leather'
                    "
                    [ngModel]="variantOptions[i].values[j]"
                    (ngModelChange)="handleOptionValueChange(i, j, $event)"
                  />
                </div>
              </div>

              <button
                class="btn btn-sm btn-outline-secondary mt-2"
                (click)="addOptionValue(i)"
              >
                + Add Value
              </button>
              <button
                class="btn btn-sm btn-outline-danger mt-2 ms-2"
                (click)="removeVariantOption(i)"
              >
                Delete
              </button>
              <button
                class="btn btn-sm btn-dark mt-2 ms-2"
                (click)="generateVariants()"
              >
                Done
              </button>
            </div>
          </div>
          <button class="btn btn-outline-primary" (click)="addVariantOption()">
            Add another option
          </button>
          <hr />
          <div>
            <label class="form-label">Group by</label>
            <select
              class="form-select w-auto"
              [(ngModel)]="groupBy"
              (change)="generateVariants()"
            >
              <option [value]="'Size'">Size</option>
              <option [value]="'Color'">Color</option>
              <option [value]="'Material'">Material</option>
            </select>
          </div>
          <div class="mt-3">
            <h6>Generated Variants</h6>
            <table class="table table-bordered">
              <thead>
                <tr>
                  <th>Variant</th>
                  <th>Image</th>
                  <th>Price</th>
                  <th>Available</th>
                </tr>
              </thead>
              <tbody>
                <ng-container *ngFor="let group of variantGroups">
                  <tr
                    class="variant-group"
                    (click)="group.expanded = !group.expanded"
                  >
                    <td colspan="4">
                      {{ group.label }} ({{ group.variants.length }} variants) â–¾
                    </td>
                  </tr>
                  <tr
                    *ngFor="let variant of group.variants"
                    [class.d-none]="!group.expanded"
                  >
                    <td>
                      {{ variant.size || "" }} {{ variant.color || "" }}
                      {{ variant.material || "" }}
                    </td>
                    <td>
                      <!-- Show upload icon box only when image is NOT selected -->
                      <div
                        class="upload-box"
                        *ngIf="!variant.image"
                        data-bs-toggle="modal"
                        data-bs-target="#singleMediaModal"
                        (click)="openVariantMediaModal(variant)"
                      >
                        <i class="fa fa-image upload-icon"></i>
                      </div>

                      <!-- Show image if selected -->
                      <div
                        *ngIf="variant.image"
                        class="position-relative"
                        style="width: 140px; height: 140px"
                      >
                        <img
                          [src]="variant.image"
                          alt="Selected Variant"
                          class="img-thumbnail"
                          style="width: 100%; height: 100%; object-fit: cover"
                        />
                        <!-- Optional: Click to change image -->
                        <div
                          class="position-absolute top-0 start-0 w-100 h-100"
                          data-bs-toggle="modal"
                          data-bs-target="#singleMediaModal"
                          style="cursor: pointer"
                          (click)="openVariantMediaModal(variant)"
                        ></div>
                      </div>
                    </td>

                    <td>
                      <input
                        type="number"
                        class="form-control"
                        [(ngModel)]="variant.price"
                      />
                    </td>
                    <td>
                      <input
                        type="number"
                        class="form-control"
                        [(ngModel)]="variant.stock"
                        (input)="updateInventoryTotal()"
                      />
                    </td>
                  </tr>
                </ng-container>
              </tbody>
            </table>
            <div class="text-end fw-bold">
              Total inventory: {{ totalInventory }}
            </div>
          </div>
        </div>
      </div>

      <!-- Right Sidebar -->
      <div class="col-lg-4">
        <div class="card">
          <h5>Status</h5>
          <select class="form-select">
            <option>Active</option>
            <option>Draft</option>
            <option>Archived</option>
          </select>
        </div>
        <div class="card">
          <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Publishing</h5>
            <a href="#" class="text-primary">Manage</a>
          </div>
          <div class="mt-2">
            <button class="btn btn-outline-secondary me-2">
              Online Store <i class="fas fa-lock ms-1"></i>
            </button>
            <button class="btn btn-outline-secondary">Point of Sale</button>
          </div>
        </div>
        <div class="card">
          <h5>Product organization <i class="fas fa-info-circle"></i></h5>
          <div class="mb-3">
            <label class="form-label">Type</label>
            <input
              type="text"
              class="form-control"
              placeholder="e.g. Shirt"
              [(ngModel)]="product.type"
            />
          </div>
          <div class="mb-3">
            <label class="form-label">Vendor</label>
            <input
              type="text"
              class="form-control"
              placeholder="e.g. Acme Co."
              [(ngModel)]="product.vendor"
            />
          </div>
        </div>
        <div class="card">
          <button class="btn btn-primary" (click)="submitProductForm()">
            Submit Product
          </button>
        </div>
      </div>
    </div>
  </div>
</app-layouts>

<app-single-media-library
  [medias]="medias"
  (confirmSelection)="onModalConfirmSelection($event)"
  (uploadSelectedFiles)="onModalFileSelected($event)"
></app-single-media-library>
