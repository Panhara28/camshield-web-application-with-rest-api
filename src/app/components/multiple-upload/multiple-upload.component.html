<div class="media-upload-box" *ngIf="allMediaUrls.length === 0">
  <label class="media-upload-label">Media</label>
  <div class="media-upload-zone">
    <div class="upload-buttons">
      <button class="upload-btn" (click)="triggerMainUpload()">
        Upload new
      </button>
      <button
        class="select-btn"
        data-bs-toggle="modal"
        data-bs-target="#mediaModal"
      >
        Select existing
      </button>
    </div>
    <p class="upload-hint">Accepts images, videos, or 3D models</p>
    <input
      type="file"
      #fileInputRef
      (change)="onFileSelected($event)"
      multiple
      hidden
    />
  </div>
</div>
<!-- Thumbnail Gallery -->
<div
  cdkDropList
  [cdkDropListData]="getConfirmedMediaList()"
  (cdkDropListDropped)="drop($event)"
  cdkDropListOrientation="mixed"
>
  <div class="container-fluid p-3">
    <!-- Thumbnails Grid -->
    <div class="row">
      <div class="col-md-4 p-0" *ngIf="getConfirmedMediaList().length">
        <div class="card large-card overflow">
          <div class="card-body">
            <img
              [src]="getConfirmedMediaList()[0].url"
              class="w-100 h-100 object-fit-cover"
              [alt]="'media'"
            />
          </div>
        </div>
      </div>
      <div class="col-md-8">
        <div class="row g-3">
          <ng-container
            *ngFor="let media of getConfirmedMediaList(); let i = index"
          >
            <div class="col-6 col-md-3" cdkDrag>
              <div class="card small-card">
                <div class="card-body">
                  <img
                    [src]="media.url"
                    class="w-100 h-100 object-fit-cover"
                    [alt]="'media'"
                  />
                </div>
              </div>
            </div>
          </ng-container>

          <!-- "+X" overlay if needed -->
          <div
            class="col-6 col-md-3"
            *ngIf="getExtraCount() > 0 && !isExpanded"
          >
            <div
              class="card small-card position-relative border rounded-3 text-white d-flex justify-content-center align-items-center"
              style="
                background-color: rgba(0, 0, 0, 0.5);
                cursor: pointer;
                flex-shrink: 0;
              "
              (click)="isExpanded = true"
            >
              <div class="fw-semibold">+{{ getExtraCount() }}</div>
            </div>
          </div>

          <!-- "+" button -->
          <div class="col-6 col-md-3">
            <div
              *ngIf="confirmedMediaUrls.size > 0"
              class="card small-card d-flex justify-content-center align-items-center border rounded-3 border-secondary-subtle"
              style="cursor: pointer"
              data-bs-toggle="modal"
              data-bs-target="#mediaModal"
            >
              <span class="fs-2 fw-light">+</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal: Select existing -->
<div
  class="modal fade"
  #mediaModal
  id="mediaModal"
  tabindex="-1"
  aria-labelledby="mediaModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Select file</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>

      <div class="modal-body">
        <!-- Filters -->
        <div
          class="d-flex flex-wrap align-items-center justify-content-between mb-3 gap-3"
        >
          <input
            type="text"
            class="form-control flex-grow-1"
            style="max-width: 400px"
            placeholder="Search files"
          />
          <div class="btn-group gap-1">
            <button class="btn btn-outline-secondary btn-sm">File type</button>
            <button class="btn btn-outline-secondary btn-sm">File size</button>
            <button class="btn btn-outline-secondary btn-sm">Used in</button>
            <button class="btn btn-outline-secondary btn-sm">Product</button>
          </div>
        </div>

        <div class="media-upload-box">
          <label class="media-upload-label">Media</label>
          <div class="media-upload-zone">
            <div class="upload-buttons">
              <button class="upload-btn" (click)="modalFileInput.click()">
                Upload new
              </button>
            </div>
            <p class="upload-hint">Accepts images, videos, or 3D models</p>
            <input
              type="file"
              #modalFileInput
              (change)="onModalFileSelected($event)"
              multiple
              hidden
            />
          </div>
        </div>

        <div class="media-grid mt-4">
          <div
            class="media-card position-relative"
            *ngFor="let media of medias"
            (click)="toggleMediaSelection(media.url)"
            [class.border-primary]="isSelectedMedia(media.url)"
            style="cursor: pointer"
          >
            <img [src]="media.url" alt="media preview" />
            <div class="caption">{{ media.filename }}</div>

            <input
              type="checkbox"
              class="form-check-input position-absolute"
              style="top: 6px; left: 6px"
              [checked]="isSelectedMedia(media.url)"
              (click)="
                $event.stopPropagation(); toggleMediaSelection(media.url)
              "
            />
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary btn-sm" data-bs-dismiss="modal">
          Cancel
        </button>
        <button
          class="btn btn-primary btn-sm"
          data-bs-dismiss="modal"
          (click)="onModalConfirmSelection()"
        >
          Done
        </button>
      </div>
    </div>
  </div>
</div>
